version: '3.8'

services:
  agent:
    build: .
    container_name: agent-server
    ports:
      - "8080:8080"
    environment:
      - QDRANT_ADDR=qdrant:6334
      # Assuming Ollama runs on host. 'host.containers.internal' works for Podman.
      # If using Docker Desktop/Compose, it might be 'host.docker.internal'.
      - OLLAMA_BASE=http://host.containers.internal:11434
    env_file:
      - .env
    volumes:
      # Volume Mapping: Host's ./doc folder -> Container's /app/doc folder
      - ./doc:/app/doc:ro
    depends_on:
      - qdrant
    # For Linux Podman to resolve host.containers.internal reliably
    extra_hosts:
      - "host.containers.internal:host-gateway"
    networks:
      - rag-net

  qdrant:
    image: qdrant/qdrant:latest
    container_name: qdrant
    ports:
      - "6333:6333"
      - "6334:6334"
    volumes:
      - ./qdrant_data:/qdrant/storage
    restart: always
    networks:
      - rag-net

  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
    extra_hosts:
      - "host.containers.internal:host-gateway"
    networks:
      - rag-net

  swagger-ui:
    image: swaggerapi/swagger-ui
    container_name: swagger-ui
    ports:
      - "8081:8080"
    volumes:
      - ./swagger/openapi.yaml:/openapi.yaml
    environment:
      SWAGGER_JSON: /openapi.yaml
    networks:
      - rag-net

  nginx:
    image: nginx:alpine
    container_name: swu-agent-nginx
    restart: unless-stopped
    ports:
      - "8090:80"
    volumes:
      - ./web/dist:/usr/share/nginx/html
      - ./nginx/nginx.conf:/etc/nginx/conf.d/default.conf
    depends_on:
      - agent
    networks:
      - rag-net

networks:
  rag-net:
    driver: bridge
